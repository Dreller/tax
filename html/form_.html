
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
    <script src="../node_modules/jquery/dist/jquery.min.js"></script>
    <script src="../node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/core.js"></script>
    <script src="../node_modules/pikaday/pikaday.js"></script>
    <script src="../node_modules/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="../node_modules/datatables.net-bs5/js/dataTables.bootstrap5.min.js"></script>
    <script src="../node_modules/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <link rel="stylesheet" href="../node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../node_modules/bootstrap-icons/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="../node_modules/pikaday/css/pikaday.css">
    <link rel="stylesheet" href="../node_modules/datatables.net-bs5/css/dataTables.bootstrap5.min.css">
    <script>
      
    </script>
    <title>{AppName}</title>
  </head>
  <body class="container-fluid">


  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header my-2 pb-1 px-2 border-bottom">
        <h5 id="WindowTitle" class="modal-title">Form...</h5>
        <button type="button" class="btn-close" aria-label="Close" onclick="CloseWin();"></button>
      </div>
      <div class="modal-body">


      <form id="MainForm" class="row g-3">


      </form>
      </div>
      <div class="modal-footer py-2 g-2">
        <button type="button" class="btn btn-primary mx-3" onclick="SaveData();">Save changes</button>
        <button type="button" class="btn btn-secondary" onclick="CloseWin();">Cancel</button>
      </div>

    </div>
  </div>


<script>
  function CloseWin(){
    Controller.Call( 'window-manager', { method: "close" } );
  }

  function SaveData(){
    var objData = {};

    $("[data-map]").each( function( ndx, elem ){
      objData[$(this).data("map")] = $(this).val();
    });
    if( taxData.action == "add" ){
      objData["id"] = crypto.randomUUID();
    }else{
      objData["id"] = taxData.id;
    }
    
    console.log( "This is the Object to save: ");
    console.log( objData );

    var objRequest = {
      key: "save",
      action: taxData.action,
      table: taxData.type,
      data: objData
    }

    Controller.Call( 'data', objRequest )
    .then( (response) => {
      CloseWin();
    });

  }

  $(document).ready(function(){
    Controller.Call( 'window-manager', { method: "get-data" } )
    .then( (response) => {
      window["taxData"] = response;
      console.log( "Data received:" );
      console.log( taxData );

      // Window Title
      let WinTitle = ( taxData.action == "add" ? "New ":"Edit " ) + CT.ProperCase( taxData.type );
      document.title = WinTitle;
      $("#WindowTitle").html( WinTitle );

      // Get Database
      Controller.Call( 'data', { key: "get-all" } )
      .then( (response) => {
        window['_DATA'] = response;

        BuildForm();
      });
    });
  });

  function BuildForm(){
    switch( taxData.type ){
      case "receipt":
        $("#MainForm").append(
          CreateObject( "select", { id: "lstPerson", label: "Person", map: "person", source: "person", divSize: 6 } ) +
          CreateObject( "select", { id: "lstDomain", label: "Expense Domain", map: "domain", source: "domain", divSize: 6 } ) + 
          CreateObject( "select", { id: "lstSupplier", label: "Supplier", map: "supplier", source: "supplier", divSize: 6 } ) +
          CreateObject( "blank", { divSize: 6 } ) + 
          CreateObject( "text", { id: "dtDate", label: "Receipt Date", map: "date", divSize: 6 } ) + 
          CreateObject( "text", { id: "txtReference", label: "Receipt Reference", map: "ref", divSize: 6 } ) + 
          CreateObject( "amount", { id: "txtAmount", label: "Full Amount", map: "amount", divSize: 4, onchange: "receiptCalculate();" } ) + 
          CreateObject( "amount", { id: "txtRefund", label: "Insured Amount", map: "refund", divSize: 4, onchange: "receiptCalculate();" } ) + 
          CreateObject( "amount", { id: "txtPaid", label: "Paid Amount", map: "paid", divSize: 4, readonly: true} ) + 
          CreateObject( "memo", { id: "txtComment", label: "Comment", map: "note", divSize: 12 } )
        );break;
      case "domain":
        $("#MainForm").append(
            CreateObject( "text", { id: "txtName", label: "Expense Domain Name", map: "name", divSize: 6} )
        );break;
      case "category":
        $("#MainForm").append(
            CreateObject( "text", { id: "txtName", label: "Category Name", map: "name", divSize: 6} ) + 
            CreateObject( "select", { id: "lstDomain", label: "Expense Domain", map: "domain", source: "domain", divSize: 6 } )
        );break;
      case "supplier":
        $("#MainForm").append(
          CreateObject( "text", { id: "txtName", label: "Supplier Name", map: "name", divSize: 6 } ) + 
          CreateObject( "select", { id: "lstDomain", label: "Expense Domain", map: "domain", source: "domain", divSize: 6 } ) + 
          CreateObject( "memo", { id: "txtAddress", label: "Address", map: "adress", divSize: 6 } ) + 
          CreateObject( "text", { id: "txtPhone", label: "Phone Number", map: "phone", divSize: 6 } ) + 
          CreateObject( "text", { id: "txtTax", label: "Tax Registration References", map: "tax", divSize: 12 } )
        );break;
      case "person":
        $("#MainForm").append(
          CreateObject( "text", { id: "txtName", label: "Person Name", map: "name", divSize: 6 } ) + 
          CreateObject( "text", { id: "txtInitial", label: "Initials", map: "initial", divSize: 3 } ) +
          CreateObject( "select", {id: "lstPartner", label: "Partner", map: "partner", divSize: 6} )
        );break;
    }

      // Are we in EDIT mode ?  If Yes, we need to set the form with actual data.
      if( taxData.action == "edit" ){
        var ThisObject = _DATA[taxData.type].find( x => x.id == taxData.id );
        $("[data-map]").each( function( ndx, elem ){
          $(this).val( ThisObject[$(this).data("map")] );
        });
      }
  }
</script>
</body> </html>